name: CI + Deploy Loan Service (Publish Profile)

on:
  push:
    branches:
      - main
    paths:
      - "backend/loan-service/**"
      - ".github/workflows/backend-ci.yml"
  workflow_dispatch:

jobs:
  deploy-loan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: backend/loan-service/package-lock.json

      - name: Install dependencies (loan-service)
        working-directory: backend/loan-service
        run: npm ci --omit=dev

      - name: Normalize WEBSITE_RUN_FROM_PACKAGE (publish profile only)
        env:
          AZURE_FUNCTIONAPP_PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
        run: |
          set -euo pipefail

          SCM_ENV_FILE="$RUNNER_TEMP/scm_env"

          python3 - <<'PY' > "$SCM_ENV_FILE"
          import os
          import shlex
          import xml.etree.ElementTree as ET

          xml = os.environ["AZURE_FUNCTIONAPP_PUBLISH_PROFILE"]
          root = ET.fromstring(xml)

          pp = None
          for method in ("zipdeploy", "msdeploy", "ftp"):
            for node in root.findall("publishProfile"):
              if (node.get("publishMethod") or "").lower() == method:
                pp = node
                break
            if pp is not None:
              break

          if pp is None:
            raise SystemExit("No publishProfile found in AZURE_FUNCTIONAPP_PUBLISH_PROFILE.")

          publish_url = pp.get("publishUrl") or ""
          host = publish_url.split(":")[0]
          user = pp.get("userName") or ""
          pwd = pp.get("userPWD") or ""

          if not host or not user or not pwd:
            raise SystemExit("Publish profile missing publishUrl/userName/userPWD.")

          print(f"export SCM_URL={shlex.quote('https://' + host)}")
          print(f"export SCM_USER={shlex.quote(user)}")
          print(f"export SCM_PWD={shlex.quote(pwd)}")
          PY

          source "$SCM_ENV_FILE"

          curl -sS --fail -u "${SCM_USER}:${SCM_PWD}" -X DELETE "${SCM_URL}/api/settings/WEBSITE_RUN_FROM_PACKAGE" >/dev/null || true
          curl -sS --fail -u "${SCM_USER}:${SCM_PWD}" -H "Content-Type: application/json" -X PUT \
            -d '{"WEBSITE_RUN_FROM_PACKAGE":"1"}' "${SCM_URL}/api/settings" >/dev/null

      - name: Deploy Loan Service via Publish Profile
        uses: Azure/functions-action@v1.5.2
        with:
          app-name: cdls-loan-service-func
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          package: backend/loan-service
          scm-do-build-during-deployment: false
          enable-oryx-build: false
